stages:
  - pos
  - purchase
  - inventory
  - sales
  - accounting
  - merge_reports

default:
  image: mcr.microsoft.com/playwright:v1.55.1-jammy
  before_script:
    - npm ci
  artifacts:
    when: always
    expire_in: 1 week

# === 1️⃣ POS ===
pos_tests:
  stage: pos
  script:
    - echo "Running POS tests..."
    - REPORT_DIR=playwright-report/pos npx playwright test tests/pos.spec.ts --output=results/pos
  artifacts:
    paths:
      - playwright-report/pos

# === 2️⃣ Purchase ===
purchase_tests:
  stage: purchase
  script:
    - echo "Running Purchase tests..."
    - REPORT_DIR=playwright-report/purchase npx playwright test tests/purchase.spec.ts --output=results/purchase
  artifacts:
    paths:
      - playwright-report/purchase

# === 3️⃣ Inventory ===
inventory_tests:
  stage: inventory
  script:
    - echo "Running Inventory tests..."
    - REPORT_DIR=playwright-report/inventory npx playwright test tests/inventory.spec.ts --output=results/inventory
  artifacts:
    paths:
      - playwright-report/inventory

# === 4️⃣ Sales ===
sales_tests:
  stage: sales
  script:
    - echo "Running Sales tests..."
    - REPORT_DIR=playwright-report/sales npx playwright test tests/sales.spec.ts --output=results/sales
  artifacts:
    paths:
      - playwright-report/sales

# === 5️⃣ Accounting ===
accounting_tests:
  stage: accounting
  script:
    - echo "Running Accounting tests..."
    - REPORT_DIR=playwright-report/accounting npx playwright test tests/accounting.spec.ts --output=results/accounting
  artifacts:
    paths:
      - playwright-report/accounting

# === 6️⃣ Merge Reports ===
merge_reports:
  stage: merge_reports
  needs:
    - pos_tests
    - purchase_tests
    - inventory_tests
    - sales_tests
    - accounting_tests
  script:
    - echo "Merging reports..."
    - mkdir -p merged-reports
    - echo "<html><head><title>Playwright Reports</title></head><body><h1>All Reports</h1><ul>" > merged-reports/index.html
    - for dir in pos purchase inventory sales accounting; do
        echo "<li><a href=\"./$dir/index.html\">${dir^} Report</a></li>" >> merged-reports/index.html;
      done
    - echo "</ul></body></html>" >> merged-reports/index.html
  artifacts:
    paths:
      - merged-reports
    expire_in: 1 week
