stages:
  - pos
  - purchase
  - inventory
  - sales
  - accounting
  - merge_reports

default:
  image: mcr.microsoft.com/playwright:v1.55.1-jammy
  before_script:
    - npm ci
  artifacts:
    when: always
    expire_in: 1 week

# === 1️⃣ POS ===
pos_tests:
  stage: pos
  script:
    - echo "Running POS tests..."
    - REPORT_DIR=playwright-report/pos npx playwright test tests/pos.spec.ts --output=results/pos
  artifacts:
    paths:
      - playwright-report/pos

# === 2️⃣ Purchase ===
purchase_tests:
  stage: purchase
  script:
    - echo "Running Purchase tests..."
    - REPORT_DIR=playwright-report/purchase npx playwright test tests/purchase.spec.ts --output=results/purchase
  artifacts:
    paths:
      - playwright-report/purchase

# === 3️⃣ Inventory ===
inventory_tests:
  stage: inventory
  script:
    - echo "Running Inventory tests..."
    - REPORT_DIR=playwright-report/inventory npx playwright test tests/inventory.spec.ts --output=results/inventory
  artifacts:
    paths:
      - playwright-report/inventory

# === 4️⃣ Sales ===
sales_tests:
  stage: sales
  script:
    - echo "Running Sales tests..."
    - REPORT_DIR=playwright-report/sales npx playwright test tests/sales.spec.ts --output=results/sales
  artifacts:
    paths:
      - playwright-report/sales

# === 5️⃣ Accounting ===
accounting_tests:
  stage: accounting
  script:
    - echo "Running Accounting tests..."
    - REPORT_DIR=playwright-report/accounting npx playwright test tests/accounting.spec.ts --output=results/accounting
  artifacts:
    paths:
      - playwright-report/accounting

# === 6️⃣ Merge Reports ===
merge_reports:
  stage: merge_reports
  needs:
    - job: pos_tests
      artifacts: true
    - job: purchase_tests
      artifacts: true
    - job: inventory_tests
      artifacts: true
    - job: sales_tests
      artifacts: true
    - job: accounting_tests
      artifacts: true
  script:
    - mkdir -p merged-reports
    # Copy reports from all stages (they are downloaded automatically via "needs: artifacts: true")
    - cp -r playwright-report/pos merged-reports/ || true
    - cp -r playwright-report/purchase merged-reports/ || true
    - cp -r playwright-report/inventory merged-reports/ || true
    - cp -r playwright-report/sales merged-reports/ || true
    - cp -r playwright-report/accounting merged-reports/ || true

    # Generate the HTML index
    - echo "<html><head><title>All Playwright Reports</title></head><body><h1>Playwright Smoke Test Reports</h1><ul>" > merged-reports/index.html
    - for dir in pos purchase inventory sales accounting; do
        if [ -d merged-reports/$dir ]; then
          echo "<li><a href=\"./$dir/index.html\">${dir^} Report</a></li>" >> merged-reports/index.html;
        else
          echo "<li>${dir^} Report (missing)</li>" >> merged-reports/index.html;
        fi;
      done
    - echo "</ul></body></html>" >> merged-reports/index.html
  artifacts:
    paths:
      - merged-reports
    expire_in: 1 week

